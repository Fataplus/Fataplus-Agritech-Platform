# Fataplus Database Migration System

This directory contains the Alembic-based database migration system for the Fataplus Agritech Platform.

## Structure

```
migrations/
├── alembic.ini              # Alembic configuration
├── env.py                   # Migration environment script
├── script.py.mako           # Migration template
├── migration_utils.py       # Migration utilities with rollback
├── versions/                # Individual migration files
│   ├── 001_initial_schema.py
│   └── ...
└── backups/                 # Database backup files
```

## Commands

### Basic Migration Commands

```bash
# Run all pending migrations
python3 -m alembic upgrade

# Rollback to a specific revision
python3 -m alembic downgrade <revision>

# Create a new migration
python3 -m alembic revision -m "Migration description"

# Show current revision
python3 -m alembic current

# Show migration history
python3 -m alembic history
```

### Using Migration Utilities

```bash
# Run migration with backup and rollback
python3 migrations/migration_utils.py upgrade

# Create migration with autogenerate
python3 migrations/migration_utils.py create --message "Add new table" --autogenerate

# Rollback to specific revision
python3 migrations/migration_utils.py downgrade --revision <revision>

# Validate migration file
python3 migrations/migration_utils.py validate --migration-file 001_initial_schema.py

# Dry run (no changes)
python3 migrations/migration_utils.py upgrade --dry-run
```

## Environment Variables

The migration system uses the following environment variables:

- `POSTGRES_HOST`: Database host (default: localhost)
- `POSTGRES_PORT`: Database port (default: 5432)
- `POSTGRES_DB`: Database name (default: fataplus_dev)
- `POSTGRES_USER`: Database username (default: fataplus_user)
- `POSTGRES_PASSWORD`: Database password

## Migration Best Practices

1. **Always test migrations in development first**
2. **Use autogenerate for simple changes**
3. **Write manual migrations for complex changes**
4. **Include downgrade functions for all migrations**
5. **Test rollback procedures**
6. **Keep migrations focused and atomic**
7. **Use descriptive commit messages**

## Rollback Strategy

The migration system includes automatic rollback capabilities:

1. **Backup Creation**: Creates database backup before each migration
2. **Error Handling**: Automatically rolls back on failure
3. **Validation**: Validates migration files before execution
4. **Version Control**: Tracks migration history and revisions

## Backup System

The system creates SQL backups before each migration:

- Stored in `migrations/backups/` directory
- Named with timestamp: `backup_YYYYMMDD_HHMMSS.sql`
- Can be used for manual recovery if needed

## Creating Migrations

### Autogenerated Migrations

For simple schema changes based on model definitions:

```bash
python3 migrations/migration_utils.py create --message "Add user preferences" --autogenerate
```

### Manual Migrations

For complex changes that require custom SQL:

```bash
python3 migrations/migration_utils.py create --message "Complex data migration"
```

Then edit the generated migration file in `versions/` directory.

## Troubleshooting

### Common Issues

1. **Connection Errors**: Ensure PostgreSQL is running and environment variables are correct
2. **Migration Conflicts**: Check current revision and use appropriate downgrade command
3. **Validation Errors**: Fix syntax errors in migration files before running
4. **Permission Errors**: Ensure database user has proper permissions

### Recovery

1. Check backup files in `backups/` directory
2. Use rollback command to revert to previous state
3. Restore from backup if necessary

## Configuration

The migration system uses the configuration from `infrastructure/docker/config_management.py`. Ensure your environment variables are properly set before running migrations.